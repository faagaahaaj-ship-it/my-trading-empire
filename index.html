<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="utf-8">
<title>外汇合约帝国</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:system-ui,-apple-system,sans-serif}
body,html{height:100%;background:#0b0e17;color:#fff;overflow:hidden}
.header{background:#1a1f2e;height:56px;display:flex;align-items:center;justify-content:space-between;padding:0 24px;font-size:19px;box-shadow:0 4px 20px rgba(0,0,0,0.7)}
.logo{color:#00ff9d;font-weight:bold;letter-spacing:1px}
.account .green{color:#00ff9d;font-weight:bold}
.main{height:calc(100% - 56px);display:flex}
.left{width:300px;background:#161b22;overflow-y:auto;border-right:1px solid #30363d}
.symbol{padding:16px;display:flex;justify-content:space-between;align-items:center;cursor:pointer;transition:.2s;border-bottom:1px solid #21262d}
.symbol:hover{background:#1f2532}
.symbol.active{background:#00ff9d;color:#000;font-weight:bold}
.chart-container{flex:1}
.right{width:420px;background:#161b22;padding:20px;display:flex;flex-direction:column}
.current-price{font-size:44px;text-align:center;margin:20px 0;color:#00ff9d;font-weight:bold}
.tabs button{flex:1;padding:16px;font-size:18px;border:none;cursor:pointer;font-weight:bold}
.buy-btn{background:#00ff9d;color:#000}
.sell-btn{background:#ff4444;color:#fff}
.buy-btn.active,.sell-btn.active{transform:scale(1.05)}
.lots-control{display:flex;gap:20px;align-items:center;justify-content:center;margin:25px 0}
.lots-control button{width:56px;height:56px;font-size:30px;background:#30363d;border-radius:12px}
.lots-control input{width:150px;padding:14px;font-size:24px;text-align:center;background:#21262d;border-radius:12px}
.order-btn{width:100%;padding:22px;font-size:26px;border:none;border-radius:12px;cursor:pointer;font-weight:bold;margin:25px 0}
.buy-order{background:#00ff9d;color:#000;box-shadow:0 10px 30px rgba(0,255,157,0.5)}
.sell-order{background:#ff4444;color:#fff;box-shadow:0 10px 30px rgba(255,68,68,0.5)}
#positions{flex:1;overflow-y:auto;margin-top:20px}
.pos-item{background:#1e2433;padding:18px;margin:10px 0;border-radius:12px;border-left:5px solid #00ff9d;position:relative}
.pos-item.sell{border-left-color:#ff4444}
.close-pos{background:#ff1744;color:#fff;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;position:absolute;right:15px;top:15px}
#tv{width:100%;height:100%}
</style>
</head>
<body>
<div class="header">
  <div class="logo">外汇合约帝国</div>
  <div class="account">模拟资金: <span class="green">$<span id="balance">100,000.00</span></span> | 总盈亏: <span id="total-pnl">$0.00</span></div>
</div>

<div class="main">
  <div class="left" id="symbol-list"></div>
  <div class="chart-container"><div id="tv"></div></div>
  <div class="right">
    <h2 style="text-align:center" id="symbol-name">黄金 XAUUSD</h2>
    <div class="current-price">$<span id="price">--</span></div>
    <div class="tabs">
      <button class="buy-btn active" id="buy-tab">买涨</button>
      <button class="sell-btn" id="sell-tab">买跌</button>
    </div>
    <div class="lots-control">
      <button onclick="changeLots(-0.01)">−</button>
      <input type="number" id="lots" value="0.10" step="0.01" min="0.01">
      <button onclick="changeLots(0.01)">+</button>
    </div>
    <button class="order-btn buy-order" id="order-btn">买入 0.10手 XAUUSD</button>
    <div id="positions"><h3 style="color:#aaa;margin:20px 0 10px">持仓列表</h3></div>
  </div>
</div>

<!-- 2025 年 GitHub Pages 最稳的 TradingView 嵌入方式 -->
<script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js" charset="utf-8"></script>
<script type="text/javascript">
new TradingView.widget({
  "autosize": true,
  "symbol": "TVC:GOLD",
  "interval": "1",
  "timezone": "Asia/Shanghai",
  "theme": "dark",
  "style": "1",
  "locale": "zh",
  "toolbar_bg": "#f1f3f6",
  "enable_publishing": false,
  "hide_side_toolbar": false,
  "allow_symbol_change": true,
  "container_id": "tv"
});
</script>

<script>
const symbols = [
  {my:"XAUUSD", tv:"TVC:GOLD", name:"黄金"},
  {my:"BTCUSD", tv:"BINANCE:BTCUSDT", name:"比特币"},
  {my:"ETHUSD", tv:"BINANCE:ETHUSDT", name:"以太坊"},
  {my:"EURUSD", tv:"FX:EURUSD", name:"欧元美元"},
];

let current = symbols[0];
let positions = [];
let direction = 'buy';

// 左侧列表
document.getElementById('symbol-list').innerHTML = symbols.map(s=>`
  <div class="symbol ${s===current?'active':''}" onclick="changeSymbol('${s.tv}','${s.my}','${s.name}')">
    <div>${s.name}<br><small>${s.my}</small></div>
    <div style="text-align:right;font-size:18px;font-weight:bold">--</div>
  </div>
`).join('');

// 切换
function changeSymbol(tvSym, mySym, name){
  current = symbols.find(s=>s.my===mySym);
  document.querySelectorAll('.symbol').forEach(el=>el.classList.remove('active'));
  event.target.closest('.symbol').classList.add('active');
  document.getElementById('symbol-name').textContent = name + ' ' + mySym;

  // 重新创建 widget（关键）
  const tv = document.getElementById('tv');
  tv.innerHTML = '';
  new TradingView.widget({
    "autosize": true,
    "symbol": tvSym,
    "interval": "1",
    "timezone": "Asia/Shanghai",
    "theme": "dark",
    "style": "1",
    "locale": "zh",
    "toolbar_bg": "#f1f3f6",
    "enable_publishing": false,
    "hide_side_toolbar": false,
    "allow_symbol_change": false,
    "container_id": "tv"
  });
}

// 实时价格（Yahoo Finance 黄金）
setInterval(()=>{
  fetch('https://api.allorigins.win/get?url='+encodeURIComponent('https://finance.yahoo.com/quote/GC=F')).then(r=>r.json()).then(d=>{
    try{
      const m = d.contents.match(/"regularMarketPrice":([^,]+),/);
      if(m){
        const price = parseFloat(m[1]);
        document.getElementById('price').textContent = price.toFixed(2);
        updatePnl();
      }
    }catch(e){}
  });
},2000);

// 下单持仓
function changeLots(v){let n = parseFloat(document.getElementById('lots').value)+v;if(n<0.01)n=0.01;document.getElementById('lots').value=n.toFixed(2);document.getElementById('order-btn').textContent=`${direction==='buy'?'买入':'卖出'} ${n.toFixed(2)}手 ${current.my}`;}
document.getElementById('buy-tab').onclick=()=>{direction='buy';document.getElementById('buy-tab').classList.add('active');document.getElementById('sell-tab').classList.remove('active');changeLots(0);}
document.getElementById('sell-tab').onclick=()=>{direction='sell';document.getElementById('sell-tab').classList.add('active');document.getElementById('buy-tab').classList.remove('active');changeLots(0);}
document.getElementById('order-btn').onclick=()=>{
  const lots = document.getElementById('lots').value;
  const price = document.getElementById('price').textContent;
  positions.push({id:Date.now(),lots,entry:parseFloat(price),dir:direction==='buy'?'多':'空'});
  alert(`已${direction==='buy'?'买入':'卖出'} ${lots}手 @ ${price}`);
  updatePnl();
};
function updatePnl(){
  const now = parseFloat(document.getElementById('price').textContent||0);
  let total = 0;
  const box = document.getElementById('positions');
  box.innerHTML = '<h3 style="color:#aaa;margin:20px 0 10px">持仓列表</h3>';
  positions.forEach(p=>{
    const pnl = p.dir==='多' ? (now-p.entry)*p.lots*100 : (p.entry-now)*p.lots*100;
    total += pnl;
    box.innerHTML += `<div class="pos-item ${p.dir==='空'?'sell':''}">
      ${p.dir} ${p.lots}手 @${p.entry.toFixed(2)} → ${now.toFixed(2)}<br>
      <span style="font-size:20px;color:${pnl>=0?'#00ff9d':'#ff4444'}">${pnl>=0?'+' : ''}${pnl.toFixed(2)}$</span>
      <button class="close-pos" onclick="positions=positions.filter(x=>x.id!==${p.id});updatePnl()">平仓</button>
    </div>`;
  });
  document.getElementById('total-pnl').textContent = total.toFixed(2);
  document.getElementById('total-pnl').style.color = total >= 0 ? '#00ff9d' : '#ff4444';
}

// 启动
changeSymbol("TVC:GOLD", "XAUUSD", "黄金");
</script>
</body>
</html>
